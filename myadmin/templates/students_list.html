<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Students â€” Admin</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Public+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <style>
      :root{--bg:#f5f6fb;--card:#fff;--muted:#617589;--text:#0f172a;--border:#e6e9ef;--accent:#0f172a;--radius:12px;font-family:"Public Sans","Noto Sans",system-ui,Arial}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font-family:inherit}
      header{background:#fff;border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
      header h1{margin:0;font-size:18px}
      .container{max-width:1100px;margin:20px auto;padding:18px}

      .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
      .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid var(--border)}
      .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:var(--accent);color:#fff;border-radius:8px;text-decoration:none;border:0}
      .ghost{background:transparent;color:var(--text);border:1px solid var(--border)}

      .table-wrap{background:var(--card);border-radius:12px;overflow:auto;border:1px solid var(--border)}
      table{width:100%;border-collapse:collapse;min-width:800px}
      thead th{background:#fbfdff;text-align:left;padding:12px;border-bottom:1px solid var(--border);font-weight:700}
      tbody td{padding:12px;border-bottom:1px solid #f1f4f8}
      a.link{ color: var(--accent);text-decoration: none; padding: 3px 11px 5px 11px;border: 1px solid #dadada;border-radius: 6px; background: white;}

      .actions form{display:inline}
      .small-btn{padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
      .block-btn{background:#ef4444;color:white}
      .unblock-btn{background:#10b981;color:white}

      .empty{padding:30px;text-align:center;color:var(--muted)}

      /* responsive */
      @media (max-width:900px){
        .container{padding:12px}
        table{min-width:640px}
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Students</h1>
      <div>
        
        <a class="btn" href="{% url 'export_students_csv' %}">Export CSV</a>
        <a class="btn" href="{% url 'dashboard' %}" style="margin-right: 3px;">&nbsp;Back&nbsp;</a>
      </div>
    </header>

    <main class="container">
      <div class="controls">
        <form method="get" class="filters" aria-label="student filters">
          <label class="sr-only">Programme</label>
          <select name="programme">
            <option value="">All programmes</option>
            {% for code,label in programmes %}
              <option value="{{ code }}" {% if selected_programme == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>

          <label class="sr-only">District</label>
          <select name="district">
            <option value="">All districts</option>
            {% for code,label in districts %}
              <option value="{{ code }}" {% if selected_district == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>

          <label class="sr-only">Payment status</label>
          <select name="payment_status">
            <option value="">All payment status</option>
            <option value="paid" {% if payment_status == 'paid' %}selected{% endif %}>Paid</option>
            <option value="unpaid" {% if payment_status == 'unpaid' %}selected{% endif %}>Unpaid</option>
          </select>

          <label class="sr-only">Search</label>
          <input type="text" name="q" placeholder="search name / phone" value="{{ search|default:'' }}">

          <button class="btn" type="submit">Filter</button>
        </form>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <a class="btn ghost" href="?">Clear</a>
          <!-- <a class="btn" href="{% url 'students_list' %}?export=filtered">Export filtered</a> -->
        </div>
      </div>

      <div class="table-wrap">
        <table role="table" aria-label="students table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Programme</th>
              <th>Room</th>
              <th>Paid until</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in students %}
              <tr>
                <td>{{ s.student_id }}</td>
                <td><a class="link" href="{% url 'student_detail' s.student_id %}">{{ s.name }}</a></td>
                <td>{{ s.get_programme_display }}</td>
                <td>{% if s.room %}{{ s.room.room_number }} ({{ s.room.block_number }}){% else %}-{% endif %}</td>
                <td>{% if s.paid_until %}{{ s.paid_until|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                <td class="actions">
                  <a class="link" href="{% url 'student_detail' s.student_id %}">Open</a>

                  {% if s.login.usertype == 'blocked' %}
                    <form action="{% url 'toggle_block_student' s.student_id %}" method="post" style="display:inline">{% csrf_token %}
                      <button class="small-btn unblock-btn" type="submit">Unblock</button>
                    </form>
                  {% else %}
                    <form action="{% url 'toggle_block_student' s.student_id %}" method="post" style="display:inline">{% csrf_token %}
                      <button class="small-btn block-btn" type="submit">Block</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="empty">No students found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- optional pagination (backend variable: page_obj) -->
      {% if page_obj %}
        <div style="display:flex;justify-content:center;margin-top:12px;gap:8px;align-items:center">
          {% if page_obj.has_previous %}<a class="btn ghost" href="?page={{ page_obj.previous_page_number }}">Prev</a>{% endif %}
          <span class="muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}<a class="btn ghost" href="?page={{ page_obj.next_page_number }}">Next</a>{% endif %}
        </div>
      {% endif %}

    </main>
  </body>
</html>
