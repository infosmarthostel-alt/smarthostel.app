<!-- Updated payment_page.html -->

{% load static %}

<head>
    <meta charset="utf-8">
    <title>Pay Rent</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --muted-color: #6c757d;
            --primary-color: #007bff;
            --primary-light: #e6f2ff;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --card-gradient: linear-gradient(135deg, #007bff, #6a11cb);
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1;
        }
        .container {
            max-width: 960px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 24px;
        }
        .payment-list {
          list-style: none;
          padding: 0;
          margin: 0;
      }
      .payment-item {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 16px 0;
          border-bottom: 1px solid #e9ecef;
      }
      .payment-item:last-child {
          border-bottom: none;
      }
      .payment-icon-box {
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
      }
      .success-icon {
          color: #28a745;
          width: 24px;
          height: 24px;
      }
      .pending-icon {
          color: #ffc107;
          width: 24px;
          height: 24px;
      }
      .payment-details {
          flex: 1;
      }
      .payment-info {
          display: flex;
          align-items: center;
          gap: 8px;
      }
      .amount {
          font-weight: 600;
          font-size: 16px;
      }
      .status-badge {
          font-size: 12px;
          font-weight: 600;
          padding: 4px 8px;
          border-radius: 20px;
          text-transform: uppercase;
      }
      .status-paid {
          background-color: #d4edda;
          color: #155724;
      }
      .status-pending {
          background-color: #fff3cd;
          color: #856404;
      }
      .status-unpaid {
          background-color: #f8d7da;
          color: #721c24;
      }
      .payment-meta {
          font-size: 13px;
          color: #6c757d;
          margin-top: 4px;
      }
      .tx-id {
          font-family: monospace;
      }
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all .2s ease;
            margin-bottom: 8px;
        }
        .payment-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
            border-color: #adb5bd;
        }
        .option-active {
            border-color: var(--primary-color);
            background: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        }
        .muted {
            color: var(--muted-color);
            font-size: 14px;
        }
        .big {
            font-size: 24px;
            font-weight: 700;
            margin-top: 4px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            background: var(--primary-color);
            color: #fff;
            text-decoration: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color .2s ease;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .qr-box {
            text-align: center;
            padding: 24px;
            background: #f1f3f5;
            border-radius: 8px;
        }
        .progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 20px;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            transition: width .6s linear;
            background: linear-gradient(90deg, #28a745, #17a2b8);
        }
        .card-visual {
            width: 280px;
            height: 170px;
            border-radius: 12px;
            padding: 20px;
            color: #fff;
            background: var(--card-gradient);
            box-shadow: 0 10px 30px rgba(0, 123, 255, 0.15);
        }
        .card-number {
            letter-spacing: 2px;
            font-size: 18px;
            font-weight: 500;
            margin-top: 18px;
        }
        .row {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            fill: none;
            stroke: var(--muted-color);
        }
        .option-active .icon {
            stroke: var(--primary-color);
        }
        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="row" style="justify-content:space-between;align-items:flex-start;">
                <div>
                    <div class="muted">Pay rent for</div>
                    <div class="big">
                        Room:
                        {% if student.room %}
                            {{ student.room.room_number }}
                        {% else %}
                            No room assigned
                        {% endif %}
                    </div>
                    <div style="margin-top:8px" class="muted">Amount: â‚¹<strong id="amount">{{ room_rent }}</strong></div>
                </div>
                <div style="text-align:right">
                    <div class="muted">Paid until</div>
                    <div id="paid_until_display" class="big">
                        {% if student.paid_until %}
                            {{ student.paid_until }}
                        {% else %}
                            Not paid
                        {% endif %}
                    </div>
                    <div class="muted" id="days_left_display">
                        {% if student.paid_until %}
                            {{ student.days_left_paid }} days left
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Choose payment method</h3>
                <div id="options" style="margin-top:20px">
                    <div class="payment-option option-active" data-method="upi">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 333334 199007" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd"><path d="M44732 130924h1856l-1738 7215c-265 1061-206 1885 147 2415 354 530 1001 795 1973 795 942 0 1737-265 2356-795 618-531 1031-1355 1296-2415l1737-7215h1885l-1767 7392c-383 1590-1060 2798-2061 3593-972 795-2268 1208-3858 1208s-2680-383-3269-1179c-589-795-707-2002-324-3592l1767-7421zm223507 11868l2826-11868h6449l-383 1649h-4564l-706 2974h4564l-413 1679h-4564l-913 3827h4565l-412 1738h-6449zm-177-8982c-413-470-913-824-1443-1031-531-235-1119-353-1797-353-1266 0-2385 412-3386 1237s-1649 1915-1973 3239c-295 1267-177 2327 413 3181 559 824 1442 1237 2620 1237 677 0 1355-118 2031-383 678-235 1356-619 2062-1119l-530 2179c-589 382-1207 648-1856 825-648 176-1296 265-2002 265-883 0-1679-148-2356-443-678-294-1236-736-1679-1324-441-560-706-1237-824-2002-117-766-88-1590 148-2474 206-883 559-1680 1031-2445 471-766 1089-1443 1796-2002 706-589 1472-1030 2297-1325 824-294 1648-441 2503-441 677 0 1295 88 1885 294 559 207 1089 500 1560 913l-500 1972zm-18317 4300h3209l-530-2710c-29-176-59-383-59-589-30-235-30-471-30-736-118 265-235 500-383 736-118 235-235 442-353 619l-1855 2680zm4093 4682l-589-3062h-4594l-2062 3062h-1972l8539-12338 2650 12338h-1972zm-15548 0l2827-11868h6449l-383 1649h-4565l-706 2945h4563l-412 1679h-4564l-1325 5565h-1885v30zm-5566-6832h353c1001 0 1679-118 2062-354 382-236 648-648 795-1267 146-648 88-1119-207-1384-293-265-913-413-1855-413h-354l-795 3417zm-471 1502l-1267 5300h-1767l2828-11867h2621c766 0 1354 59 1737 148 411 89 736 265 971 500 295 295 471 648 559 1119 89 443 59 943-59 1502-235 943-619 1709-1207 2238-589 530-1326 854-2209 972l2680 5387h-2121l-2562-5300h-206zm-11632 5330l2828-11868h6478l-382 1649h-4565l-706 2974h4564l-411 1679h-4565l-912 3827h4564l-413 1738h-6479zm-2031-10248l-2444 10218h-1884l2444-10218h-3063l383-1649h8010l-382 1649h-3063zm-19170 10248l2945-12338 5595 7244c148 206 294 413 441 648s295 501 471 794l1974-8216h1737l-2945 12310-5713-7392c-147-206-295-412-441-619-147-235-265-442-354-707l-1972 8245h-1737v30zm-4594 0l2827-11868h1884l-2827 11868h-1884zm-13870-2385l1678-707c29 530 176 942 501 1207 324 265 765 413 1354 413 559 0 1031-148 1443-471 412-324 678-736 795-1266 177-707-235-1326-1236-1855-147-89-235-148-325-177-1119-648-1825-1207-2120-1737-294-530-354-1149-176-1884 235-972 736-1738 1530-2356 796-589 1679-913 2740-913 854 0 1530 177 2031 500 501 325 766 825 854 1444l-1648 766c-148-383-325-648-560-825-235-176-530-265-884-265-501 0-942 147-1295 412-354 265-589 619-707 1090-176 707 325 1383 1472 2002 89 59 147 89 207 117 1001 530 1678 1061 1972 1591 295 529 354 1148 178 1943-266 1119-825 2002-1680 2680-853 647-1855 1002-3033 1002-971 0-1737-237-2267-708-589-471-854-1149-824-2002zm-1973-7863l-2444 10218h-1884l2444-10218h-3062l381-1649h8010l-383 1649h-3062zm-19170 10248l2944-12338 5596 7244c147 206 295 413 442 648 146 235 294 501 471 794l1973-8216h1737l-2944 12310-5713-7392c-148-206-294-412-442-619-147-235-265-442-353-707l-1973 8245h-1737v30zm-8599 0l2827-11868h6449l-383 1649h-4564l-707 2974h4564l-412 1679h-4564l-913 3827h4565l-413 1738h-6449zm-3121-5860c0-88 29-354 88-766 30-353 59-618 89-854-118 266-236 530-383 824-147 266-324 560-530 825l-4535 6331-1472-6448c-59-265-118-530-148-766-29-235-59-500-59-736-59 236-147 500-235 794-89 266-206 560-354 855l-2650 5831h-1737l5683-12368 1620 7479c29 118 59 324 89 589 29 266 88 619 147 1031 206-353 471-765 825-1296 88-146 176-235 206-324l5124-7479-177 12368h-1737l148-5890zm-17933 5860l1296-5418-2356-6420h1972l1472 4035c30 117 59 235 118 411 59 178 89 354 147 530 118-176 236-353 354-530 118-176 236-324 353-471l3446-3975h1884l-5506 6390-1296 5417h-1885v30zm-8746-4682h3209l-530-2710c-30-176-59-383-59-589-30-235-30-471-30-736-118 265-236 500-383 736-118 235-235 442-354 619l-1855 2680zm4063 4682l-589-3062h-4594l-2061 3062h-1973l8540-12338 2650 12338h-1973zm-11808-6920h471c1031 0 1767-118 2179-354 412-235 677-647 825-1237 146-618 58-1089-236-1324-324-265-972-383-1943-383h-471l-825 3299zm-501 1590l-1266 5330h-1767l2827-11868h2856c854 0 1443 59 1826 147s678 236 913 471c294 265 500 648 589 1119 88 472 59 972-59 1531-147 560-353 1090-677 1561s-707 854-1119 1119c-353 206-736 382-1148 471-412 88-1060 148-1885 148h-1089v-30zm-17580 3563h1590c854 0 1531-59 2003-176 471-117 883-324 1266-589 530-383 972-854 1325-1443 354-560 619-1237 795-2002 176-766 235-1414 147-1972-88-561-294-1061-648-1444-265-294-589-471-1030-589-442-118-1119-176-2091-176h-1354l-2003 8392zm-2297 1767l2828-11868h2532c1649 0 2798 88 3415 265 619 177 1148 442 1561 854 530 530 884 1208 1031 2002 147 825 88 1767-147 2798-266 1060-648 1972-1178 2796-530 825-1207 1473-2002 2003-589 413-1237 678-1944 854-677 177-1708 265-3063 265h-3033v30zm-8628 0l2827-11868h6449l-383 1649h-4565l-707 2974h4565l-412 1679h-4565l-913 3827h4565l-412 1738h-6449zm-4565 0l2827-11868h1884l-2827 11868h-1885zm-8540 0l2827-11868h6449l-383 1649h-4564l-707 2945h4564l-412 1679h-4565l-1325 5565h-1885v30zm-4565 0l2827-11868h1884l-2827 11868h-1885zm-13015 0l2944-12338 5595 7244c147 206 294 413 442 648 147 235 294 501 471 794l1973-8216h1737l-2944 12310-5713-7392c-147-206-294-412-442-619-147-235-265-442-353-707l-1973 8245h-1737v30z" fill="#3a3734"/><path d="M233961 120588h-12927l17963-64873h12927l-17963 64873zm-107424-4064c-707 2562-3063 4358-5713 4358H54185c-1826 0-3180-619-4064-1855-883-1238-1089-2769-559-4594l16255-58541h12928l-14518 52298h51710l14517-52298h12928l-16844 60632zm100710-58777c-883-1237-2268-1855-4152-1855h-71027l-3504 12721h64608l-3769 13576h-51680v-30h-12927l-10719 38724h12927l7185-25973h58100c1826 0 3534-619 5124-1855 1590-1237 2651-2768 3151-4594l7185-25972c559-1943 383-3504-501-4741z" fill="#716d6a"/><path fill="#0e8635" d="M274245 55833l16344 32510-34365 32510 4087-14747 18794-17763-8941-17785z"/><path fill="#e97208" d="M262762 55833l16343 32510-34395 32510z"/><path d="M31367 0h270601c8631 0 16474 3528 22156 9210 5683 5683 9211 13526 9211 22156v136275c0 8629-3529 16472-9211 22155-5683 5682-13526 9211-22155 9211H31368c-8629 0-16473-3528-22156-9211C3530 184114 2 176272 2 167641V31366c0-8631 3528-16474 9210-22156S22738 0 31369 0zm270601 10811H31367c-5647 0-10785 2315-14513 6043s-6043 8866-6043 14513v136275c0 5646 2315 10784 6043 14512 3729 3729 8867 6044 14513 6044h270601c5645 0 10783-2315 14512-6044 3728-3729 6044-8867 6044-14511V31368c0-5645-2315-10784-6043-14513-3728-3728-8867-6043-14513-6043z" fill="gray" fill-rule="nonzero"/></svg>
                      <span>UPI (Pay via app)</span>
                    </div>
                    <div class="payment-option" data-method="qr">
                      <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5.5" y="15" width="3.5" height="3.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="15" y="5.5" width="3.5" height="3.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="5.5" y="5.5" width="3.5" height="3.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="11.75" y="5.5" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="11.75" y="8.625" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="8.625" y="11.75" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="11.75" y="14.875" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="11.75" y="18" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="5.5" y="11.75" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="11.75" y="11.75" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="14.875" y="11.75" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="18" y="11.75" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="14.875" y="14.875" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="18" y="14.875" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="14.875" y="18" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        <rect x="18" y="18" width="0.5" height="0.5" stroke="#6c757d" stroke-linejoin="round"/>
                        </svg>
                        <span>QR (Scan to pay)</span>
                    </div>
                    <div class="payment-option" data-method="card">
                        <svg class="icon" viewBox="0 0 24 24" stroke="currentColor"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        <span>Credit / Debit Card</span>
                    </div>
                    <div class="payment-option" data-method="netbanking">
                        <svg class="icon" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        <span>Netbanking</span>
                    </div>
                    <div class="payment-option" data-method="wallet">
                      <svg class="icon"  viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16.5008 14.1502H16.5098M19 4.00098H6.2C5.0799 4.00098 4.51984 4.00098 4.09202 4.21896C3.71569 4.41071 3.40973 4.71667 3.21799 5.093C3 5.52082 3 6.08087 3 7.20098V16.801C3 17.9211 3 18.4811 3.21799 18.909C3.40973 19.2853 3.71569 19.5912 4.09202 19.783C4.51984 20.001 5.07989 20.001 6.2 20.001H17.8C18.9201 20.001 19.4802 20.001 19.908 19.783C20.2843 19.5912 20.5903 19.2853 20.782 18.909C21 18.4811 21 17.9211 21 16.801V11.201C21 10.0809 21 9.52082 20.782 9.093C20.5903 8.71667 20.2843 8.41071 19.908 8.21896C19.4802 8.00098 18.9201 8.00098 17.8 8.00098H7M16.9508 14.1502C16.9508 14.3987 16.7493 14.6002 16.5008 14.6002C16.2523 14.6002 16.0508 14.3987 16.0508 14.1502C16.0508 13.9017 16.2523 13.7002 16.5008 13.7002C16.7493 13.7002 16.9508 13.9017 16.9508 14.1502Z" stroke="#6c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Wallet</span>
                    </div>
                </div>

                <div id="method_area" style="margin-top:24px">
                    <div id="upi_area">
                        <div class="muted">Open your UPI app and use the UPI deeplink or scan the QR.</div>
                        <div style="margin-top:16px">
                            {% if unpaid_fees %}
                            <button id="pay_upi" class="btn" title="please pay the unpaid fees first" class="btn" style=" margin-top: 16px;width: 100%;pointer-events:none; display:none;  cursor: not-allowed;opacity: 0.1;" >Pay with UPI</button>
                            <button id="pay_upi-fraud" class="btn" title="Please pay the unpaid fees first" class="btn" style=" margin-top: 16px;width: 100%; cursor: not-allowed;opacity: 0.7;" disabled>Pay with UPI</button>
                            {% else %}
                            <button id="pay_upi" class="btn">Pay with UPI</button>
                            {% endif %}
                            
                        </div>
                    </div>

                    <div id="qr_area" style="display:none">
                        <div class="qr-box">
                            <div id="qr_svg" style="display:inline-block;padding:8px;background:#fff;border-radius:6px"><img width="190px" src="/static/qr.png" alt="QR"></div>
                            <div class="muted" style="margin-top:12px">Scan with any UPI app</div>
                        </div>
                        <div style="text-align:center;margin-top:16px;">
                            {% if unpaid_fees %}
                            <button id="simulate_scan" class="btn" title="please pay the unpaid fees first" class="btn" style=" margin-top: 16px;width: 100%;cursor: not-allowed;opacity: 0.6;" disabled>I scanned & paid</button>
                                {% else %}
                                <button id="simulate_scan" class="btn">I scanned & paid</button>
                                {% endif %}
                            
                        </div>
                    </div>

                    <div id="card_area" style="display:none">
                        <div style="display:flex;flex-wrap:wrap;gap:20px;align-items:center">
                            <div class="card-visual">
                                <div style="font-size:14px;opacity:0.9">Hostel Rent</div>
                                <div class="card-number" id="card_number_visual">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</div>
                                <div style="display:flex;justify-content:space-between;margin-top:24px;font-size:12px">
                                    <div style="font-size:12px">VALID THRU<br><strong>12/30</strong></div>
                                    <div style="font-size:12px">CARD HOLDER<br><strong>{{ student.name }}</strong></div>
                                </div>
                            </div>
                            <div style="flex:1;min-width:250px;">
                                <input id="card_input" type="text" placeholder="Card number" />
                                <div style="display:flex;gap:12px;margin-top:12px">
                                    <input id="expiry" type="text" placeholder="MM/YY" style="flex:1;" />
                                    <input id="cvv" type="text" placeholder="CVV" style="width:100px;" />
                                </div>
                                {% if unpaid_fees %}
                                <button id="pay_card" 
                                        class="btn" 
                                        title="please pay the unpaid fees first"
                                        style="margin-top:16px;width:100%;" 
                                        disabled>
                                    Pay â‚¹<span id="card_amount">{{ room_rent }}</span>
                                </button>
                                {% else %}
                                <button id="pay_card" class="btn" style="margin-top:16px;width:100%;">
                                    Pay â‚¹<span id="card_amount">{{ room_rent }}</span>
                                </button>
                                {% endif %}

                            </div>
                        </div>
                    </div>

                    <div id="netbanking_area" style="display:none">
                        <div class="muted">Netbanking is not supported in this demo. Please choose another payment method.</div>
                    </div>
                    
                    <div id="wallet_area" style="display:none">
                        <div class="muted">Wallet payments are not supported in this demo. Please choose another payment method.</div>
                    </div>
                    
                    <div style="margin-top:24px">
                        <div class="progress"><div class="progress-bar" id="progressbar"></div></div>
                        <div id="status_msg" style="margin-top:12px" class="muted">Status: idle</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Recent payments</h3>
                <ul class="payment-list">
                    {% for f in student.fees.all|slice:":8" %}
                    <li class="payment-item">
                        <div class="payment-icon-box">
                            {% if f.status == 'Paid' %}
                            <svg class="success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-8.85"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            {% else %}
                            <svg class="pending-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            {% endif %}
                        </div>
                        <div class="payment-details">
                            <div class="payment-info">
                                <span class="amount">â‚¹{{ f.amount }}</span>
                                <span class="status-badge status-{{ f.status|lower }}">{{ f.status|title }}</span>
                            </div>
                            <div class="payment-meta">
                                <span class="date">{{ f.payment_date }}</span>
                                {% if f.payment_tx %}
                                <span class="tx-id">(Tx: {{ f.payment_tx.tx_id|slice:":8" }}...)</span>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            
                {% if unpaid_fees %}
                <h3 style="margin-top: 24px;">Outstanding Fees</h3>
                <ul class="payment-list">
                    {% for f in unpaid_fees %}
                    <li class="payment-item">
                        <div class="payment-icon-box">
                            <svg class="pending-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="payment-details">
                            <div class="payment-info">
                                <span class="amount">â‚¹{{ f.amount }}</span>
                                <span class="status-badge status-unpaid">Unpaid</span>
                            </div>
                            <div class="payment-meta">
                                <span class="date">Due: {{ f.due_date }}</span>
                                {% if f.note %}<span>{{ f.note }}</span>{% endif %}
                            </div>
                        </div>
                        <button class="btn pay_fee" data-fee_id="{{ f.fee_id }}" data-amount="{{ f.amount }}" style="padding:8px 16px; font-size:14px;">Pay Now</button>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>

        </div>
    </div>

<script>
    (function(){
        const options = document.querySelectorAll('.payment-option');
        let selected = 'upi';
        options.forEach(el=>{
            el.addEventListener('click', ()=> {
                options.forEach(o=> o.classList.remove('option-active'));
                el.classList.add('option-active');
                selected = el.dataset.method;
                document.getElementById('upi_area').style.display = 'none';
                document.getElementById('qr_area').style.display = 'none';
                document.getElementById('card_area').style.display = 'none';
                document.getElementById('netbanking_area').style.display = 'none';
                document.getElementById('wallet_area').style.display = 'none';
                if (document.getElementById(selected + '_area')) {
                    document.getElementById(selected + '_area').style.display = 'block';
                }
                document.getElementById('status_msg').innerText = 'Status: idle';
            });
        });

        const default_amount = document.getElementById('amount').innerText;
        let current_amount = default_amount;
        let current_fee_id = null;

        // helper to create tx
        async function createTx(method){
            const params = {method: method, amount: current_amount};
            if (current_fee_id) {
                params.fee_id = current_fee_id;
            }
            const resp = await fetch("{% url 'create_transaction' %}", {
                method:'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type':'application/x-www-form-urlencoded'},
                body: new URLSearchParams(params)
            });
            return resp.json();
        }

        // helper to finalize
        async function finalizeTx(tx_id){
            const resp = await fetch("{% url 'finalize_transaction' %}", {
                method:'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type':'application/x-www-form-urlencoded'},
                body: new URLSearchParams({tx_id: tx_id, provider_txn_id: 'SIMULATED-' + Math.random().toString(36).slice(2,9)})
            });
            return resp.json();
        }

        // UPI button
        document.getElementById('pay_upi').addEventListener('click', async ()=>{
            document.getElementById('status_msg').innerText = 'Creating UPI transaction...';
            const data = await createTx('upi');
            setProgress(30);
            document.getElementById('status_msg').innerText = 'Opening UPI app...';
            window.open(data.upi_deeplink, '_blank');
            setTimeout(async ()=>{
                setProgress(70);
                document.getElementById('status_msg').innerText = 'Waiting for confirmation...';
                const fin = await finalizeTx(data.tx_id);
                setProgress(100);
                document.getElementById('status_msg').innerText = 'Success' + (fin.paid_until ? ': Paid until ' + fin.paid_until : '');
                if (fin.paid_until) {
                    document.getElementById('paid_until_display').innerText = fin.paid_until;
                    document.getElementById('days_left_display').innerText = fin.days_left + ' days left';
                }
                setTimeout(() => location.reload(), 1500);
            }, 1800);
        });

        // QR flow
        document.getElementById('simulate_scan').addEventListener('click', async ()=>{
            document.getElementById('status_msg').innerText = 'Creating QR transaction...';
            const data = await createTx('qr');
            const svgel = '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%" height="100%" fill="#fff"/><text x="10" y="20" font-family="Arial" font-size="10" fill="#111">UPI QR (demo)</text><text x="10" y="40" font-family="Arial" font-size="8" fill="#444">'+data.upi_deeplink.slice(0,70)+'...</text><rect x="50" y="60" width="100" height="100" fill="#ddd"/></svg>';
            document.getElementById('qr_svg').innerHTML = svgel;
            setProgress(50);
            document.getElementById('status_msg').innerText = 'Waiting for you to scan & pay...';
            setTimeout(async ()=> {
                setProgress(80);
                const fin = await finalizeTx(data.tx_id);
                setProgress(100);
                document.getElementById('status_msg').innerText = 'Success' + (fin.paid_until ? ': Paid until ' + fin.paid_until : '');
                if (fin.paid_until) {
                    document.getElementById('paid_until_display').innerText = fin.paid_until;
                    document.getElementById('days_left_display').innerText = fin.days_left + ' days left';
                }
                setTimeout(() => location.reload(), 1500);
            }, 2200);
        });

        // Card flow (simulated)
        document.getElementById('pay_card').addEventListener('click', async ()=>{
            document.getElementById('status_msg').innerText = 'Creating card transaction...';
            const data = await createTx('card');
            setProgress(25);
            document.getElementById('status_msg').innerText = 'Processing card...';
            setTimeout(()=> setProgress(55), 900);
            setTimeout(()=> setProgress(85), 1600);
            setTimeout(async ()=>{
                const fin = await finalizeTx(data.tx_id);
                setProgress(100);
                document.getElementById('status_msg').innerText = 'Success' + (fin.paid_until ? ': Paid until ' + fin.paid_until : '');
                if (fin.paid_until) {
                    document.getElementById('paid_until_display').innerText = fin.paid_until;
                    document.getElementById('days_left_display').innerText = fin.days_left + ' days left';
                }
                setTimeout(() => location.reload(), 1500);
            }, 2400);
        });

        // Outstanding fees pay buttons
        const pay_fee_buttons = document.querySelectorAll('.pay_fee');
        pay_fee_buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                current_fee_id = btn.dataset.fee_id;
                current_amount = btn.dataset.amount;
                document.getElementById('amount').innerText = current_amount;
                document.getElementById('card_amount').innerText = current_amount;
                const active_method = document.querySelector('.option-active').dataset.method;
                const pay_btn_map = {
                    upi: 'pay_upi',
                    qr: 'simulate_scan',
                    card: 'pay_card'
                };
                const pay_btn_id = pay_btn_map[active_method];
                if (pay_btn_id) {
                    document.getElementById(pay_btn_id).click();
                } else {
                    alert('Please select a supported method: UPI, QR, or Card');
                }
            });
        });

        function setProgress(p){
            document.getElementById('progressbar').style.width = p + '%';
        }
    })();
</script>